version: "3.8"

services:
  vpn:
    build:
      context: ../vpn
    container_name: vpn-client
    privileged: true
    devices:
      - /dev/net/tun
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ../vpn/configs:/etc/vpn/configs:ro
      - ../vpn/auth:/etc/vpn/auth:ro
    environment:
      - VPN_CONFIG=${VPN_CONFIG:-/etc/vpn/configs/default.ovpn}
      - VPN_AUTH_FILE=${VPN_AUTH_FILE:-}
      - VPN_IFACE=${VPN_IFACE:-}

  agent:
    build:
      context: ../agent
    container_name: vpn-agent
    network_mode: "service:vpn"  # shares vpn network
    depends_on:
      - vpn
    volumes:
      - ../tests:/tests:ro
      - ../results:/results
      - ../agent/visit_urls.sh:/agent/visit_urls.sh:ro
      - ../agent/webrtc_check.js:/agent/webrtc_check.js:ro
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - VPN_IFACE=${VPN_IFACE:-}
      - VPN_CONFIG=${VPN_CONFIG:-/etc/vpn/configs/default.ovpn}
    command: ["/agent/visit_urls.sh"]

